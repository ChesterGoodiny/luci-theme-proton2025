name: Build IPK & APK Packages

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build LuCI Theme Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="1.0.0-$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare package files
        id: prepare
        run: |
          PKG_NAME="luci-theme-proton2025"

          # –°–æ–∑–¥–∞—ë–º –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
          mkdir -p pkg-data/www/luci-static/proton2025
          mkdir -p pkg-data/www/luci-static/resources
          mkdir -p pkg-data/usr/share/ucode/luci/template/themes/proton2025
          mkdir -p pkg-data/usr/share/rpcd/acl.d
          mkdir -p pkg-data/usr/share/rpcd/ucode
          mkdir -p pkg-data/etc/uci-defaults
          mkdir -p pkg-data/etc/config

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Ç–µ–º—ã
          cp -r htdocs/luci-static/proton2025/* pkg-data/www/luci-static/proton2025/
          cp -r ucode/template/themes/proton2025/* pkg-data/usr/share/ucode/luci/template/themes/proton2025/
          cp root/etc/uci-defaults/30_luci-theme-proton2025 pkg-data/etc/uci-defaults/

          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥
          if [ -f "root/etc/config/proton2025" ]; then
            cp root/etc/config/proton2025 pkg-data/etc/config/
          fi

          # –ö–æ–ø–∏—Ä—É–µ–º RPC –º–æ–¥—É–ª–∏ –∏ ACL
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-temp" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-temp pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/ucode/luci.proton-settings" ]; then
            cp root/usr/share/rpcd/ucode/luci.proton-settings pkg-data/usr/share/rpcd/ucode/
          fi
          if [ -f "root/usr/share/rpcd/acl.d/luci-theme-proton2025.json" ]; then
            cp root/usr/share/rpcd/acl.d/luci-theme-proton2025.json pkg-data/usr/share/rpcd/acl.d/
          fi

          # –ö–æ–ø–∏—Ä—É–µ–º JS –º–µ–Ω—é
          if [ -d "htdocs/luci-static/resources" ]; then
            cp -r htdocs/luci-static/resources/* pkg-data/www/luci-static/resources/ 2>/dev/null || true
          fi

          # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
          INSTALLED_SIZE=$(du -sb pkg-data | cut -f1)
          echo "size=$INSTALLED_SIZE" >> $GITHUB_OUTPUT

      - name: Build IPK (for OpenWrt with opkg)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p ipk-build/control
          mkdir -p ipk-build/data
          cp -r pkg-data/* ipk-build/data/

          # –°–æ–∑–¥–∞—ë–º control —Ñ–∞–π–ª
          cat > ipk-build/control/control << 'CONTROL_END'
          Package: luci-theme-proton2025
          Depends: libc, luci-base
          License: Apache-2.0
          Section: luci
          Architecture: all
          Description: Proton2025 - Elegant Dark Theme for LuCI
          CONTROL_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/control
          sed -i "1s/.*/Package: ${PKG_NAME}/" ipk-build/control/control
          sed -i "2i Version: ${VERSION}" ipk-build/control/control
          sed -i "4i Source: https://github.com/${{ github.repository }}" ipk-build/control/control
          sed -i "5i SourceName: ${PKG_NAME}" ipk-build/control/control
          sed -i "/Architecture/a Installed-Size: ${INSTALLED_SIZE}" ipk-build/control/control

          # –°–æ–∑–¥–∞—ë–º postinst —Å–∫—Ä–∏–ø—Ç
          cat > ipk-build/control/postinst << 'POSTINST_END'
          #!/bin/sh
          [ -n "${IPKG_INSTROOT}" ] || {
            uci -q set luci.themes.Proton2025=/luci-static/proton2025
            uci -q commit luci
            /etc/init.d/rpcd restart 2>/dev/null || true
          }
          exit 0
          POSTINST_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/postinst
          chmod 755 ipk-build/control/postinst

          # –°–æ–∑–¥–∞—ë–º prerm —Å–∫—Ä–∏–ø—Ç
          cat > ipk-build/control/prerm << 'PRERM_END'
          #!/bin/sh
          [ -n "${IPKG_INSTROOT}" ] || {
            uci -q delete luci.themes.Proton2025
            uci -q commit luci
          }
          exit 0
          PRERM_END
          sed -i 's/^[[:space:]]*//' ipk-build/control/prerm
          chmod 755 ipk-build/control/prerm

          # –°–æ–±–∏—Ä–∞–µ–º IPK
          cd ipk-build/control && tar czvf ../control.tar.gz . && cd ../..
          cd ipk-build/data && tar czvf ../data.tar.gz . && cd ../..
          echo "2.0" > ipk-build/debian-binary
          cd ipk-build && tar czvf "../${PKG_NAME}_${VERSION}_all.ipk" ./debian-binary ./control.tar.gz ./data.tar.gz && cd ..

          echo "Built IPK: ${PKG_NAME}_${VERSION}_all.ipk"
          ls -la *.ipk

      - name: Build APK (for OpenWrt 24.10+ with apk)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG_NAME="luci-theme-proton2025"
          INSTALLED_SIZE="${{ steps.prepare.outputs.size }}"

          mkdir -p apk-build

          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ /)
          cp -r pkg-data/* apk-build/

          # –°–æ–∑–¥–∞—ë–º .PKGINFO (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ APK –ø–∞–∫–µ—Ç–∞) —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
          cat > apk-build/.PKGINFO << PKGINFO_END
          pkgname = ${PKG_NAME}
          pkgver = ${VERSION}-r1
          pkgdesc = Proton2025 - Elegant Dark Theme for LuCI
          url = https://github.com/${{ github.repository }}
          size = ${INSTALLED_SIZE}
          arch = noarch
          license = Apache-2.0
          origin = ${PKG_NAME}
          depend = luci-base
          PKGINFO_END

          # –°–æ–∑–¥–∞—ë–º .post-install —Å–∫—Ä–∏–ø—Ç
          cat > apk-build/.post-install << 'POSTINSTALL_END'
          #!/bin/sh
          uci -q set luci.themes.Proton2025=/luci-static/proton2025
          uci -q commit luci
          /etc/init.d/rpcd restart 2>/dev/null || true
          exit 0
          POSTINSTALL_END
          chmod 755 apk-build/.post-install

          # –°–æ–∑–¥–∞—ë–º .pre-deinstall —Å–∫—Ä–∏–ø—Ç
          cat > apk-build/.pre-deinstall << 'PREDEINSTALL_END'
          #!/bin/sh
          uci -q delete luci.themes.Proton2025
          uci -q commit luci
          exit 0
          PREDEINSTALL_END
          chmod 755 apk-build/.pre-deinstall

          # –°–æ–±–∏—Ä–∞–µ–º APK (Alpine Package format)
          # APK —Ç—Ä–µ–±—É–µ—Ç gzip —Å–∂–∞—Ç–∏–µ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ñ–∞–π–ª–æ–≤
          cd apk-build

          # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞ (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏)
          find . -type f -o -type l | grep -v '^\./\.' | sort > .file-list

          # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º: —Å–Ω–∞—á–∞–ª–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –ø–æ—Ç–æ–º —Ñ–∞–π–ª—ã
          tar -czf "../${PKG_NAME}_${VERSION}_all.apk" \
            --owner=0 --group=0 \
            --numeric-owner \
            .PKGINFO .post-install .pre-deinstall \
            $(cat .file-list)

          cd ..

          echo "Built APK: ${PKG_NAME}_${VERSION}_all.apk"
          ls -lh *.apk

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-ipk
          path: "*.ipk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-proton2025-apk
          path: "*.apk"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.ipk
            *.apk
          body: |
            ## Proton2025 Theme v${{ steps.version.outputs.version }}

            ### üì¶ Packages
            - **`.ipk`** ‚Äî –¥–ª—è OpenWrt —Å opkg (–≤–µ—Ä—Å–∏–∏ –¥–æ 24.x)
            - **`.apk`** ‚Äî –¥–ª—è OpenWrt —Å apk (–≤–µ—Ä—Å–∏–∏ 24.10+)

            ### üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

            **opkg (IPK):**
            ```bash
            opkg install luci-theme-proton2025_*.ipk
            ```

            **apk (APK):**
            ```bash
            apk add --allow-untrusted luci-theme-proton2025_*.apk
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
